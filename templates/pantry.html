<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Pantry</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f6f1eb;
  --card:#fffaf4;
  --accent:#986533;
  --text:#3b2f2f;
  --safe:#e7f6ec;
  --warn:#fff1db;
  --danger:#ffe3e3;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Inter",system-ui,sans-serif;
  background: linear-gradient(135deg, rgba(246, 241, 235, 0.85), rgba(232, 220, 198, 0.85)), 
              url('https://images.unsplash.com/photo-1542838132-92c53300491e?w=1920&h=1080&fit=crop&crop=center') center/cover no-repeat fixed;
  color:var(--text);
  position: relative;
}

/* ===== NAVBAR ===== */
.navbar{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(255, 250, 244, 0.95);
  backdrop-filter: blur(10px);
  padding:18px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
.navbar a{
  margin-left:25px;
  text-decoration:none;
  font-weight:600;
  color:#7a3e2f;
}

/* ===== PAGE ===== */
.page{ 
  padding:30px 50px; 
  position: relative;
  z-index: 10;
}

/* ===== HEADER ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:35px;
}
.header h1{ font-size:34px; }

/* ===== STATS ===== */
.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
  margin-bottom:40px;
}
.stat{
  background:var(--card);
  padding:25px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
}
.stat b{ font-size:32px; }

/* ===== QUICK HIGHLIGHTS ===== */
.highlights{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
  margin-bottom:40px;
}
.highlight{
  background:linear-gradient(135deg,#fffaf4,#f1e7dc);
  padding:25px;
  border-radius:22px;
  font-weight:600;
}

/* ===== ADD ITEM ===== */
.add-card{
  background:linear-gradient(135deg,#fffaf4,#f1e7dc);
  padding:30px;
  border-radius:24px;
  display:grid;
  grid-template-columns:2fr 1fr 0.8fr 0.8fr 1fr auto;
  gap:15px;
  margin-bottom:45px;
}
.add-card input,.add-card select,.add-card button{
  padding:14px;
  border-radius:12px;
  border:none;
}
.add-card button{
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
}

/* ===== SECTIONS ===== */
.section-title{
  font-size:22px;
  margin:35px 0 15px;
}

/* ===== SCROLL ===== */
.scroll-row{
  display:flex;
  gap:20px;
  overflow-x:auto;
  padding-bottom:20px;
}

/* ===== ITEM CARD ===== */
.item{
  min-width:280px;
  background:var(--card);
  border-radius:22px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  transition:.3s;
}
.item:hover{ transform:translateY(-6px); }
.item img{
  width:100%;
  height:170px;
  object-fit:cover;
  border-radius:16px;
}
.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
}
.safe{background:var(--safe)}
.warn{background:var(--warn)}
.danger{background:var(--danger)}
.expired{background:#e74c3c;color:white}
.item a{
  display:block;
  margin-top:10px;
  font-weight:600;
  text-decoration:none;
  color:#7a3e2f;
}

/* ===== EXPIRED ITEMS ===== */
.expired-section{
  background:#fff5f5;
  padding:25px;
  border-radius:22px;
  border:2px solid #ffe3e3;
  margin-bottom:40px;
}
.expired-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.clear-expired-btn{
  background:#e74c3c;
  color:white;
  padding:12px 20px;
  border-radius:12px;
  text-decoration:none;
  font-weight:600;
  font-size:14px;
  transition:background 0.3s;
}
.clear-expired-btn:hover{
  background:#c0392b;
}
.expired-item{
  border:2px solid #e74c3c;
  background:#fff5f5;
}
.expired-item:hover{
  transform:translateY(-3px);
}

/* ===== PLANNER ===== */
.planner{
  background:white;
  padding:25px;
  border-radius:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
}
.planner-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.planner-header h4{
  margin:0;
  color:var(--text);
}
.planner-link{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
  font-size:14px;
}
.planner-link:hover{
  color:#7a3e2f;
}
.planner-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:12px;
  margin-bottom:15px;
}
.day{
  background:var(--card);
  padding:12px 8px;
  border-radius:12px;
  font-weight:600;
  text-align:center;
  font-size:13px;
  min-height:60px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.planned-meal{
  color:var(--accent);
  font-size:11px;
  font-weight:normal;
  margin-top:5px;
}
.no-meal{
  color:#999;
  font-size:11px;
  font-weight:normal;
  margin-top:5px;
}
.planner-note{
  font-size:12px;
  color:#666;
  text-align:center;
}
.planner-note a{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
}

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
  backdrop-filter: blur(5px);
}

.modal-content{
  background:white;
  padding:40px;
  border-radius:24px;
  width:90%;
  max-width:600px;
  box-shadow:0 25px 50px rgba(0,0,0,.2);
  position: relative;
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #f1e7dc;
}

.modal-header h3{
  margin: 0;
  color: #7a3e2f;
  font-size: 24px;
  font-weight: 700;
}

.close-btn{
  background: none;
  border: none;
  font-size: 28px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.close-btn:hover{
  background: #f1e7dc;
  color: #7a3e2f;
}

.chart-container{
  position: relative;
  height: 300px;
  margin-bottom: 20px;
}

.chart-stats{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.chart-stat{
  text-align: center;
  padding: 15px;
  background: #f8f5f1;
  border-radius: 12px;
}

.chart-stat-number{
  font-size: 28px;
  font-weight: bold;
  color: #986533;
  margin-bottom: 5px;
}

.chart-stat-label{
  font-size: 14px;
  color: #666;
  font-weight: 600;
}

.chart-btn{
  background:var(--card);
  border:none;
  padding:14px 20px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}

.chart-btn:hover{
  background: #986533;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(152, 101, 51, 0.3);
}

/* ===== LOGOUT ===== */
.logout{
  margin-top:50px;
  text-align:right;
}
.logout a{
  text-decoration:none;
  font-weight:600;
  color:#7a3e2f;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <h2>ü•ó Smart Pantry</h2>
  <div>
    <a href="/pantry">Pantry</a>
    <a href="/recipes/all">All Recipes</a>
    <a href="/recipes/saved">Saved Recipes</a>
    <a href="/planner">Meal Planner</a>
    <a href="/test-expiry-email" style="color: #f39c12;">Test Expiry Email</a>
    <a href="/logout">Logout</a>
  </div>
</div>

<div class="page">

<!-- HEADER -->
<div class="header">
  <h1>Your Pantry Overview</h1>
  <div>
    {% if not db_connected %}
    <div style="background: #fff3cd; color: #856404; padding: 12px 20px; border-radius: 12px; margin-bottom: 10px; font-size: 14px; font-weight: 600;">
      ‚ö†Ô∏è Demo Mode: <a href="https://dashboard.render.com" target="_blank" style="color: #986533;">Set up MongoDB Atlas</a> for full functionality
    </div>
    {% endif %}
    <button class="chart-btn" onclick="openChart()">View Analytics</button>
  </div>
</div>

<!-- STATS -->
<div class="stats">
  <div class="stat"><b>{{ stats.total }}</b><br>Active Items</div>
  <div class="stat"><b>{{ stats.soon }}</b><br>Expiring Soon</div>
  <div class="stat"><b>{{ stats.safe }}</b><br>Safe Items</div>
  <div class="stat"><b>{{ stats.expired }}</b><br>Expired Items</div>
</div>

<!-- HIGHLIGHTS -->
<div class="highlights">
  <div class="highlight">üìä Smart Inventory Tracking</div>
  <div class="highlight">‚è∞ Expiry Date Monitoring</div>
  <div class="highlight">‚ôªÔ∏è Zero Food Waste Goal</div>
</div>

<!-- ADD ITEM -->
<form class="add-card" method="POST" action="/add">
  <input name="name" placeholder="Food name" required>
  <select name="category" required>
    <option value="">Select category</option>
    <option value="fruits">Fruits</option>
    <option value="vegetables">Vegetables</option>
    <option value="dairy">Dairy</option>
    <option value="meat">Meat</option>
    <option value="grains">Grains</option>
    <option value="other">Other</option>
  </select>
  <input type="number" name="quantity" placeholder="Quantity" min="1" value="1" required>
  <select name="unit" required>
    <option value="">Unit</option>
    <option value="kg">Kg</option>
    <option value="grams">Grams</option>
    <option value="liters">Liters</option>
    <option value="ml">ML</option>
    <option value="pieces">Pieces</option>
    <option value="packets">Packets</option>
    <option value="bottles">Bottles</option>
    <option value="cans">Cans</option>
  </select>
  <input type="date" name="expiry" required>
  <button>Add Item</button>
</form>

<!-- PANTRY -->
<div class="section-title">Your Pantry</div>

{% if items|length == 0 %}
<div class="stat" style="text-align:center">üß∫ Pantry is empty ‚Äî add items above</div>
{% endif %}

<div class="scroll-row">
{% for item in items %}
  <div class="item">
    <img src="{{ item.image }}" 
         alt="{{ item.name }}"
         onerror="this.onerror=null; this.src='/static/food-placeholder.svg';"
         loading="lazy">
    <h3>{{ item.name }}</h3>
    <p><strong>{{ item.quantity }} {{ item.unit }}</strong></p>
    <p>{{ item.days_left }} days left</p>
    {% if item.days_left <= 3 %}
      <span class="badge danger">Urgent</span>
    {% elif item.days_left <= 7 %}
      <span class="badge warn">Use Soon</span>
    {% else %}
      <span class="badge safe">Fresh</span>
    {% endif %}
    <a href="/recipes?item={{ item.name }}">üçΩÔ∏è View Recipes</a>
    <a href="/delete/{{ item._id }}" onclick="return confirm('Remove {{ item.name }} from pantry?')">üóëÔ∏è Remove</a>
  </div>
{% endfor %}
</div>

<!-- EXPIRED ITEMS SECTION -->
{% if expired_items %}
<div class="section-title" style="color: #e74c3c;">‚ö†Ô∏è Expired Items</div>
<div class="expired-section">
  <div class="expired-header">
    <p style="color: #666; margin: 0 0 20px 0;">These items have passed their expiry date. Consider removing them from your pantry.</p>
    <a href="/clear_expired" class="clear-expired-btn" onclick="return confirm('Remove all expired items from pantry?')">
      üóëÔ∏è Clear All Expired Items
    </a>
  </div>
  
  <div class="scroll-row">
    {% for item in expired_items %}
    <div class="item expired-item">
      <img src="{{ item.image }}" 
           alt="{{ item.name }}"
           onerror="this.onerror=null; this.src='/static/food-placeholder.svg';"
           loading="lazy">
      <h3>{{ item.name }}</h3>
      <p><strong>{{ item.quantity }} {{ item.unit }}</strong></p>
      <p style="color: #e74c3c;">Expired {{ abs(item.days_left) }} days ago</p>
      <span class="badge expired">Expired</span>
      <a href="/delete/{{ item._id }}" onclick="return confirm('Remove {{ item.name }} from pantry?')">üóëÔ∏è Remove</a>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}



<!-- PANTRY INSIGHTS -->
<div class="section-title">üìà Pantry Insights</div>
<div class="planner">
  <div class="planner-header">
    <h4>Items by Expiry Status</h4>
    <a href="/planner" class="planner-link">Plan Meals ‚Üí</a>
  </div>
  <div class="planner-grid">
    {% if items %}
      {% for item in items[:7] %}
      <div class="day">
        <strong>{{ item.name }}</strong><br>
        {% if item.days_left <= 3 %}
          <span class="planned-meal" style="color: #e74c3c;">{{ item.days_left }} days</span>
        {% elif item.days_left <= 7 %}
          <span class="planned-meal" style="color: #f39c12;">{{ item.days_left }} days</span>
        {% else %}
          <span class="planned-meal" style="color: #27ae60;">{{ item.days_left }} days</span>
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="day">
        <span class="no-meal">No items yet</span>
      </div>
    {% endif %}
  </div>
  <div class="planner-note">
    üí° Keep track of expiry dates to minimize waste. <a href="/planner">Create meal plans ‚Üí</a>
  </div>
</div>

<!-- LOGOUT -->
<div class="logout">
  <a href="/logout">Logout</a>
</div>

</div>

<!-- ANALYTICS MODAL -->
<div class="modal" id="chartModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìä Pantry Analytics</h3>
      <button class="close-btn" onclick="closeChart()">&times;</button>
    </div>
    
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    
    <div class="chart-stats">
      <div class="chart-stat">
        <div class="chart-stat-number">{{ stats.total }}</div>
        <div class="chart-stat-label">Active Items</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-number">{{ stats.safe }}</div>
        <div class="chart-stat-label">Safe Items</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-number">{{ stats.soon }}</div>
        <div class="chart-stat-label">Expiring Soon</div>
      </div>
      <div class="chart-stat">
        <div class="chart-stat-number">{{ stats.expired }}</div>
        <div class="chart-stat-label">Expired Items</div>
      </div>
    </div>
  </div>
</div>

<script>
let chartInstance = null;

function openChart(){
  document.getElementById("chartModal").style.display="flex";
  
  // Destroy existing chart if it exists
  if (chartInstance) {
    chartInstance.destroy();
  }
  
  const ctx = document.getElementById("chart").getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Safe Items', 'Expiring Soon', 'Expired Items'],
      datasets: [{
        data: [{{ stats.safe }}, {{ stats.soon }}, {{ stats.expired }}],
        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              size: 14,
              weight: '600'
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: 'white',
          bodyColor: 'white',
          borderColor: '#986533',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true
        }
      },
      animation: {
        animateRotate: true,
        duration: 1000
      }
    }
  });
}

function closeChart(){
  document.getElementById("chartModal").style.display="none";
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('chartModal');
  if (event.target === modal) {
    closeChart();
  }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeChart();
  }
});
</script>

</body>
</html>